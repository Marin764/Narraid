<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语音转文字与间隔分析</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .result-section {
            margin-top: 20px;
            display: none;
        }
        .recording-indicator {
            display: none;
            color: #dc3545;
            margin-left: 10px;
        }
        .recording-indicator.active {
            display: inline-block;
            animation: blink 1s infinite;
        }
        .word-detail {
            display: inline-block;
            margin: 5px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .word-text {
            font-size: 1.2em;
            font-weight: bold;
        }
        .word-timing {
            font-size: 0.8em;
            color: #666;
        }
        .interval-high {
            background-color: #ffebee;
        }
        .interval-medium {
            background-color: #fff3e0;
        }
        .interval-low {
            background-color: #e8f5e9;
        }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">语音转文字与间隔分析</h1>
        
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-center">
                            <button id="recordButton" class="btn btn-danger">
                                <i class="fas fa-microphone"></i> 开始录音
                            </button>
                            <span class="recording-indicator">
                                <i class="fas fa-circle"></i> 正在录音...
                            </span>
                        </div>
                        <div class="mt-3 text-center">
                            <audio id="audioPlayer" controls style="display: none;"></audio>
                        </div>
                    </div>
                </div>

                <div class="result-section" id="resultSection">
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">识别结果</h5>
                        </div>
                        <div class="card-body">
                            <div id="transcriptionResult"></div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">间隔分析</h5>
                        </div>
                        <div class="card-body">
                            <div id="intervalResult"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        function getIntervalClass(interval) {
            if (interval < 0.2) return 'interval-short';
            if (interval < 0.4) return 'interval-medium';
            return 'interval-long';
        }

        document.getElementById('recordButton').addEventListener('click', async () => {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true
                        } 
                    });
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audioPlayer = document.getElementById('audioPlayer');
                        audioPlayer.src = audioUrl;
                        audioPlayer.style.display = 'block';
                        
                        const formData = new FormData();
                        formData.append('file', audioBlob, 'recording.wav');
                        
                        try {
                            const response = await fetch('/upload', {
                                method: 'POST',
                                body: formData
                            });

                            const data = await response.json();
                            
                            document.getElementById('resultSection').style.display = 'block';
                            
                            // 显示识别文本
                            let transcriptionHtml = '';
                            data.transcription.forEach(segment => {
                                transcriptionHtml += `
                                    <div class="segment-container mb-4">
                                        <p class="mb-2">${segment.text}</p>
                                        <div class="word-container">
                                            ${segment.words.map(word => `
                                                <div class="word-detail ${getIntervalClass(word.interval_to_next)}">
                                                    <div class="word-text">${word.text}</div>
                                                    <div class="word-timing">
                                                        <div>开始: ${word.start.toFixed(3)}s</div>
                                                        <div>结束: ${word.end.toFixed(3)}s</div>
                                                        <div>持续: ${word.duration.toFixed(3)}s</div>
                                                        <div>停顿: ${word.interval_to_next.toFixed(3)}s</div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            });
                            document.getElementById('transcriptionResult').innerHTML = transcriptionHtml;
                            
                            // 显示间隔分析
                            let intervalHtml = '';
                            data.interval_analysis.forEach(result => {
                                intervalHtml += `
                                    <div class="mb-3">
                                        <p>${result.text}</p>
                                        <p>
                                            平均间隔: ${result.avg_interval.toFixed(3)}秒<br>
                                            间隔标准差: ${result.std_interval.toFixed(3)}秒
                                        </p>
                                    </div>
                                `;
                            });
                            document.getElementById('intervalResult').innerHTML = intervalHtml;
                            
                        } catch (error) {
                            console.error('Error:', error);
                            alert('处理过程中出现错误，请重试');
                        }
                        
                        audioChunks = [];
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById('recordButton').innerHTML = '<i class="fas fa-stop"></i> 停止录音';
                    document.getElementById('recordButton').classList.remove('btn-danger');
                    document.getElementById('recordButton').classList.add('btn-primary');
                    document.querySelector('.recording-indicator').classList.add('active');
                    
                } catch (error) {
                    console.error('Error:', error);
                    alert('无法访问麦克风，请确保已授予麦克风访问权限');
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('recordButton').innerHTML = '<i class="fas fa-microphone"></i> 开始录音';
                document.getElementById('recordButton').classList.remove('btn-primary');
                document.getElementById('recordButton').classList.add('btn-danger');
                document.querySelector('.recording-indicator').classList.remove('active');
                
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html> 